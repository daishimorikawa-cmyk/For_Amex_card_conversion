# Amex Card Statement Converter Plan

## 概要
Amexの利用明細PDF（2ページ目以降）から利用明細テーブルを抽出し、CSV/TSV形式で出力するPythonアプリケーションです。
個人情報保護を最優先し、ローカルで徹底的なお浄化（画像化、クロップ、マスキング）を行ってからデータ抽出を行います。

## 技術スタック
- **Frontend/UI**: Streamlit
- **PDF処理**: pdf2image (要Poppler)
- **OCR**: pytesseract (要Tesseract-OCR) または pdfplumber (テキストレイヤーがある場合推奨)
- **AI/LLM**: Google Gemini API (抽出・整形用)
- **画像処理**: Pillow, OpenCV

## 処理フロー

1. **PDFアップロード**: ユーザーがPDFをアップロード
2. **前処理 (Local)**:
   - **画像化**: PDFをページごとに画像(300dpi)に変換
   - **Page 1除外**: 1ページ目は自動的に破棄
   - **Page 2以降の処理**:
     - 空白ページ判定
     - **クロップ**: ヘッダー（氏名・会員番号）を除外し、明細テーブル領域のみを切り出し
     - **OCR/テキスト化**: 画像からテキストを抽出
     - **マスキング**: 正規表現を用いて、カード番号、口座番号、電話番号、メアド等を `****` に置換
3. **期間抽出 (Local)**:
   - 1ページ目から「明細書作成対象期間」のみを安全に抽出（正規表現）
4. **データ抽出 (LLM)**:
   - マスキング済みのテキストデータをLLMに送信
   - 「日付」「支払相手先」「金額」の構造化データを要求
   - 支払相手先のクリーニング（数字以降の削除など）
5. **後処理**:
   - 年号の補完
   - CSV/TSV生成
6. **出力**:
   - 画面にTSV表示
   - CSVダウンロード

## 必要な環境設定 (Windows)
このツールを動作させるには、以下の外部ツールのインストールが必要になる可能性があります：
1. **Poppler** (PDFを画像に変換するため)
2. **Tesseract-OCR** (画像から文字を読み取るため)

## 開発ステップ
1. 環境構築 (`requirements.txt`)
2. 前処理ロジックの実装（画像化・クロップ・OCR実験）
3. LLMプロンプトの設計と結合
4. Streamlit UIの実装
5. テストと検証
